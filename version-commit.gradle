import java.text.SimpleDateFormat

//使用默认task的方式嵌入
//defaultTasks 'versionCommit'
task("versionCommit") {
    versionCommit()
}
//在processResources之后执行
//processResources.finalizedBy versionCommit

def versionCommit() {
    Properties p = new Properties()
    p.put("branch", getGitBranch())
    p.put("commitId", getGitCommitId())
    p.put("commitText", getGitCommitText())
    p.put("commitTime", getGitCommitTime())
    p.put("commitAuthorName", getGitCommitAuthorName())
    p.put("commitAuthorEmail", getGitCommitAuthorEmail())
    p.put("buildPackageTime", getBuildPackageTime())
    p.store(new FileWriter("app/src/main/assets/version-commit.properties"), "generated by gradle git info plugin")
}

// 获取 Git 分支信息
def getGitBranch() {
    return 'git rev-parse --abbrev-ref HEAD'.execute().text.trim()
}

// 获取 Git 分支下 CommitId 信息
def getGitCommitId() {
    return 'git rev-parse --short HEAD'.execute().text.trim()
//    return 'git describe --always'.execute().text.trim()
}

// 获取 Git 分支下该 CommitId 的 CommitText 信息
def getGitCommitText() {
    String commitId = getGitCommitId();
    String cmd = "git log --pretty=format:%s $commitId -1";
    return cmd.execute().text.trim()
}

// 获取 Git 分支下该 CommitId 的 CommitTime 信息
def getGitCommitTime() {
    String commitId = getGitCommitId();
    String cmd = "git log --pretty=format:%ai $commitId -1";
    return cmd.execute().text.trim();
}

// 获取 Git 分支下该 CommitId 的 CommitAuthorName 信息
def getGitCommitAuthorName() {
    String commitId = getGitCommitId();
    String cmd = "git log --pretty=format:%an $commitId -1";
    return cmd.execute().text.trim()
}

// 获取 Git 分支下该 CommitId 的 CommitAuthorEmail 信息
def getGitCommitAuthorEmail() {
    String commitId = getGitCommitId();
    String cmd = "git log --pretty=format:%ae $commitId -1";
    return cmd.execute().text.trim()
}

// 获取生成包时间
def getBuildPackageTime() {
    return new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date())
}